
## 数据类型

bitmap  todo

## 单线程

redis6.0开始就不是单线程了，


## 持久化机制


## 节点

Redis Cluster为整个集群定义了一共16384个slot，并通过CRC16的hash算法计算key对应的slot，然后路由到该slot所在的redis节点

#### 1.将节点加入Redis Cluster中
#### 2.为集群中的节点分配slot(分配完成后，每个即诶单不仅直到自己的slot列表，还需要知道别的节点的slot列表)
#### 3.分配完成后，key会根据crc16计算出得结果和16384取模进行slot定位，从而定位到具体节点。

### 重新分配slot
所有分片的算法都会面对一个问题，就是当节点增加或减少时怎么处理,Redis Cluster也不例外
当有节点D加入进来原本的A,B,C节点需要拿出一部分slot给到D，这样的操作就叫做slot重新分配。

### redis-trib todo
redis Cluster 是使用redis-trib来自动实现的slot重新分配

---
## 分布式锁

### “占坑”原理

同时去请求，占到则处理逻辑，否则通过自旋锁方式等待重试

> 问题：如果拿到锁之后，出现异常，导致未删除锁，则造成死锁

### 给锁设置过期时间

即使业务出现问题，没有主动删除，也会自动过期删除

> 问题：如果执行expire命令设置过期时间时，出现异常，则依然会出现死锁

### 获取锁和设置锁过期时间，必须是原子操作

redis支持setNxEx命令

> 问题：拿到锁之后执行业务逻辑，如果正好要删除锁时，锁又过期了，另一个线程拿到了锁并且设置了新value，那么这时再删除就是删除别人的锁了。

### 确保加锁和解锁都是原子操作

使用redis+Lua脚本

保证加锁【占位+过期时间】和删除锁【判断+删除】的原子性




## 锁的自动续期 todo
---





## 缓存穿透
缓存穿透的概念很简单，用户想要查询一个数据，发现 redis 内存数据库没有，于是向持久层数据库查询。
当用户很多的时候，缓存都没有命中，于是都去请求了持久层数据库。
这会给持久层数据库造成很大的压力，这时候就出现了缓存穿透。
### 1、布隆过滤器
布隆过滤器是一种数据结构，对所有可能查询的参数以 hash 形式存储，在控制层先行校验，不符合则丢弃，减小了对底层存储系统的查询压力。

### 2、缓存空对象
当持久层数据库未查询到时，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了持久层数据库。

注意：缓存空对象会存在两个问题：
- 如果空值能够被缓存起来，这当中可能会有很多储存了空值的键。
- 即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对于需要保持一致性的业务会有影响。


## 缓存击穿
缓存击穿是当某个key在过期的瞬间，有大量的请求查询redis查不到而涌向持久层数据库的问题，会导使数据库瞬间压力过大。


> **区别**：
> 缓存穿透与缓存击穿的区别是：穿透是一直查redis查不到数据，而击穿是瞬间的查redis数据查不到。
> 相同点：都会给持久化层数据库造成压力。

### 1、设置热点数据永不过期

### 2、加互斥锁，即保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。

## 缓存雪崩
缓存雪崩，是指在某一个时间段，缓存集中过期失效，也可能是redis集群全部宕机。
大量的请求都涌向持久化数据库，数据库的调用量会暴增，造成数据库也会挂掉的情况。

其实集中过期，倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮


### 1、Redis 高可用，搭建集群
这个思想的含义是，既然redis有可能挂掉，那我多增设几台redis，这样一台挂掉之后其他的还可以继续工作，也就是搭建集群。
### 2、限流降级
这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。
### 3、数据预热
数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。



## redis 键过期的删除策略？



















